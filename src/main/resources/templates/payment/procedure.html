<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>결제 페이지</title>
<link rel="stylesheet" href="https://unpkg.com/ress/dist/ress.min.css">
<link rel="stylesheet" href="/css/payment/payment.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
    
</head>
<body>
<header th:include="fragments/header.html"></header>
<div class="paymentContainer">
	<div class="content">
        <div class="paymentTitle">
            <h1>수강결제</h1>
        </div>
        <div class="paymentcontent">
            <div class="dataTable1">
                <table>
                    <thead>
                        <tr>
                            <th>강좌구분</th>
                            <th>강좌정보</th>
                            <th>수강자명</th>
                            <th>결제금액</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="lecture : ${lectureList}">
                            <td th:text="${lecture.lcName}"></td>
                            <td th:utext="|[본점] ${lecture.lTitle}<br>
                            강사 : ${lecture.instructorName}<br>
                            ${#dates.format(lecture.lrStartDate, 'yyyy-MM-dd')} ~ ${#dates.format(lecture.lrEndDate, 'yyyy-MM-dd')}<br>
                            ${lecture.lrStartTime} ~ ${lecture.lrEndTime}|">
                            </td>
                            <td>홍길동</td>
                            <td class="lrFee" th:text="|${lecture.lrFee}원|"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="dataTable2">
                <table>
                    <thead>
                        <tr>
                            <th>총 수강료</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span id="total" style="color: red;"></span>원</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="paymentBtnArea">
                <input type="submit" value="결제하기" onclick="iamport()">
            </div>
        </div>
    </div>
</div>
<footer th:include="fragments/footer.html"></footer>
<script>
	
	let lrFee = $('.lrFee');
	let totalFee = 0;
	
	for(let i=0; i< lrFee.length; i++){
		totalFee += Number(lrFee[i].innerText.slice(0, -1).replace(/,/g, ""));
		
	}
	
	let viewTotal = ("" + totalFee).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	
	$('#total')[0].innerText = viewTotal;
	
	
    let productName = "강의명";
    let price = 100;
    let userName = "장영재";
    
    function iamport(){
		//가맹점 식별코드
		IMP.init('imp76581344');
		IMP.request_pay({
		    pg : 'kcp',
		    pay_method : 'card',
		    merchant_uid : "" + new Date().getTime(),
		    name : productName , //결제창에서 보여질 이름
		    amount : price, //실제 결제되는 가격
		    buyer_email : 'jdudwo@google.com',
		    buyer_name : userName,
		}, function(rsp) {
			console.log(rsp);
		    if ( rsp.success ) {
		    	var msg = '결제가 완료되었습니다.';
		        msg += '고유ID : ' + rsp.imp_uid;
		        msg += '상점 거래ID : ' + rsp.merchant_uid;
		        msg += '결제 금액 : ' + rsp.paid_amount;
		        msg += '카드 승인번호 : ' + rsp.apply_num;
		    } else {
		    	 var msg = '결제에 실패하였습니다.';
		         msg += '에러내용 : ' + rsp.error_msg;
		    }
		    alert(msg);
		});
	}
    
</script>
</body>
</html>